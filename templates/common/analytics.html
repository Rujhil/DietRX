<div class="container" id="analytics">
  <h2>DietRx Analytics</h2>

  <!-- Buttons -->
  <div class="btn-group mb-4 d-flex justify-content-center flex-wrap" role="group" aria-label="Analytics Graphs">
    <button id="btn-plant" class="btn btn-primary btn-analytics" onclick="showGraph('chart-plant', this)" aria-pressed="false">Plant</button>
    <button id="btn-plantder" class="btn btn-primary btn-analytics" onclick="showGraph('chart-plantder', this)" aria-pressed="false">Plant Derivative</button>
    <button id="btn-alcoholicbev" class="btn btn-primary btn-analytics" onclick="showGraph('chart-alcoholicbev', this)" aria-pressed="false">Alcoholic Beverages</button>
    <button id="btn-dairy" class="btn btn-primary btn-analytics" onclick="showGraph('chart-dairy', this)" aria-pressed="false">Dairy</button>
    <button id="btn-meategg" class="btn btn-primary btn-analytics" onclick="showGraph('chart-meategg', this)" aria-pressed="false">Meat & Eggs</button>
  </div>

  <!-- Chart Sections -->
  <div class="chart-sections">
    <div class="section" id="section-alcoholicbev" style="display:none;">
      <div id="chart-alcoholicbev" style="height:600px;"></div>
    </div>
    <div class="section" id="section-dairy" style="display:none;">
      <div id="chart-dairy" style="height:600px;"></div>
    </div>
    <div class="section" id="section-meategg" style="display:none;">
      <div id="chart-meategg" style="height:600px;"></div>
    </div>
    <div class="section" id="section-plant" style="display:none;">
      <div id="chart-plant" style="height:600px;"></div>
    </div>
    <div class="section" id="section-plantder" style="display:none;">
      <div id="chart-plantder" style="height:600px;"></div>
    </div>
  </div>
</div>

<script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
<script>
  function showGraph(graphId, btn) {
    $('.section').hide();
    $('.btn-analytics')
      .removeClass('btn-analytics-active')
      .attr('aria-pressed', 'false');

    if (btn) {
      $(btn)
        .addClass('btn-analytics-active')
        .attr('aria-pressed', 'true');
    }

    const mapping = {
      'chart-alcoholicbev': ['alcoholicbev', 'section-alcoholicbev', 'Alcoholic Beverages'],
      'chart-dairy': ['dairy', 'section-dairy', 'Dairy'],
      'chart-meategg': ['meategg', 'section-meategg', 'Meat & Eggs'],
      'chart-plant': ['plant', 'section-plant', 'Plant'],
      'chart-plantder': ['plantder', 'section-plantder', 'Plant Derivative']
    };

    if (mapping[graphId]) {
      const [slug, sectionId, title] = mapping[graphId];
      $(`#${sectionId}`).fadeIn(300);
      drawCSVBar(slug, graphId, `Top 50 ${title} by Positive vs Negative`);
    }
  }

  function drawCSVBar(slug, elementId, title) {
    const chartContainer = document.getElementById(elementId);

    fetch(`/dietrx/api/analytics/top50_csv/${slug}`)
      .then(response => {
        if (!response.ok) {
          throw new Error(`HTTP error! Status: ${response.status}`);
        }
        return response.json();
      })
      .then(data => {
        if (!Array.isArray(data) || data.length === 0) {
          chartContainer.innerHTML = '<p>No data available.</p>';
          return;
        }

        data.sort((a, b) => b.positive_count - a.positive_count);

        const y = data.map(d => d.display_name);
        const pos = data.map(d => d.positive_count);
        const neg = data.map(d => d.negative_count);

        Plotly.newPlot(elementId, [
          {
            y: y,
            x: pos,
            name: 'Positive',
            type: 'bar',
            orientation: 'h',
            marker: { color: '#28a745' }
          },
          {
            y: y,
            x: neg,
            name: 'Negative',
            type: 'bar',
            orientation: 'h',
            marker: { color: '#dc3545' }
          }
        ], {
          title: title,
          barmode: 'stack',
          xaxis: {
            title: {
              text: 'Number of Publications',
              font: { size: 16, color: '#207872' }
            },
            tickfont: { color: '#207872' },
            gridcolor: '#d6f2ef'
          },
          yaxis: {
            title: {
              text: 'Food',
              font: { size: 16, color: '#207872' }
            },
            tickfont: { color: '#207872' },
            automargin: true
          },
          plot_bgcolor: '#f0ffe0',
          paper_bgcolor: '#f0ffe0',
          height: 700,
          margin: { l: 200, t: 50, r: 50 }
        });
      })
      .catch(error => {
        console.error("Chart load failed:", error);
        chartContainer.innerHTML = '<p style="color:red;">Error loading chart.</p>';
      });
  }

  window.addEventListener('load', function () {
    $('#btn-alcoholicbev').addClass('btn-analytics-active').attr('aria-pressed', 'true');
    showGraph('chart-alcoholicbev', document.getElementById('btn-alcoholicbev'));
  });
</script>